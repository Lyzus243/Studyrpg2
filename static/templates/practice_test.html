<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Test - StudyRPG</title>
    <style>
        body {
           background: linear-gradient(
                135deg,
                #1a1a2e 0%,
                #1e3c72 25%,
                #e52d27 60%,
                #ffb347 85%,
                #6df0ff 100%
            );
            background-size: 400% 400%;
            animation: gradientPulse 15s ease infinite;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }

        @keyframes gradientPulse {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .back-link {
            display: block;
            margin-bottom: 2rem;
            color: white;
            text-decoration: underline;
        }

        .timer-display {
            background: rgba(229, 45, 39, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
            font-weight: bold;
            border: 2px solid rgba(229, 45, 39, 1);
        }

        .test-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .test-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-rpg, .btn-rpg {
            padding: 12px 20px;
            border: 2px solid rgba(30, 60, 114, 0.8);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-rpg {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-rpg {
            background: rgba(30, 60, 114, 0.8);
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-rpg:hover:not(:disabled) {
            background: rgba(42, 82, 152, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.4);
        }

        .btn-rpg:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .question {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 5px solid #1e3c72;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .question h4 {
            margin-bottom: 15px;
            color: white;
            font-size: 1.1em;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .options label {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .options label:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .options input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        #testResults, #resultsArea {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #submitTest {
            background: rgba(229, 45, 39, 0.8);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            border: 2px solid rgba(229, 45, 39, 1);
        }

        #submitTest:hover:not(:disabled) {
            background: rgba(209, 35, 32, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 45, 39, 0.4);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.8);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .answer-review {
            margin-top: 20px;
        }

        .answer-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .answer-item.correct {
            border-left-color: #10b981;
        }

        .answer-item.incorrect {
            border-left-color: #ef4444;
        }

        .score-display {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .score-display.passing {
            color: #10b981;
        }

        .score-display.failing {
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .test-controls {
                flex-direction: column;
            }
            
            .input-rpg, .btn-rpg {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <a href="/ai-tools" class="back-link">‚Üê Back to AI Tools</a>
        <h1>üìù Practice Test - StudyRPG</h1>
        
        <div class="test-controls">
            <select id="materialSelect" class="input-rpg">
                <option value="">Select material...</option>
            </select>
            <input type="number" id="testDuration" class="input-rpg" placeholder="Duration (minutes)" min="5" max="120" value="30">
            <button id="generateTimedTest" class="btn-rpg">Generate Timed Test</button>
            <button id="generatePracticeTest" class="btn-rpg">Generate Practice Test</button>
            <button id="newTest" class="btn-rpg" onclick="location.reload()">New Test</button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading hidden">
            <div>ü§ñ AI is generating your test...</div>
            <div style="margin-top: 10px; font-size: 0.9em;">This may take a few moments</div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error hidden"></div>

        <!-- Test Info -->
        <div id="testInfo" class="test-info hidden">
            <h3 id="testTitle"></h3>
            <p id="testInstructions"></p>
            <div id="questionCount"></div>
        </div>

        <!-- Timer Display -->
        <div id="timerDisplay" class="timer-display hidden">
            ‚è∞ Time Remaining: <span id="testTimer">30:00</span>
        </div>

        <!-- Test Area -->
        <div id="testArea" class="hidden">
            <div id="questionsContainer"></div>
            <button id="submitTest">Submit Test</button>
        </div>

        <!-- Results -->
        <div id="resultsArea" class="hidden">
            <h2>üìä Test Results</h2>
            <div id="scoreDisplay" class="score-display"></div>
            <div id="answerReview" class="answer-review"></div>
            <button class="btn-rpg" onclick="location.reload()" style="margin-top: 20px;">Take Another Test</button>
        </div>
    </div>

    <script>
        let currentTest = null;
        let materials = [];
        let timerInterval = null;
        let startTime = null;

        async function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            return parts.length === 2 ? parts.pop().split(';').shift() : null;
        }

        async function loadMaterials() {
            try {
                const token = await getCookie('access_token');
                const response = await fetch('/materials', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch materials');
                
                materials = await response.json();
                const select = document.getElementById('materialSelect');
                
                if (materials.length === 0) {
                    select.innerHTML = '<option value="">No materials found</option>';
                } else {
                    select.innerHTML = '<option value="">Select material...</option>' +
                        materials.map(m => `<option value="${m.id}">${m.title || m.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Failed to load materials:', error);
                showError('Failed to load materials. Please refresh the page.');
            }
        }

        async function generateTimedTest() {
            const materialId = document.getElementById('materialSelect').value;
            const duration = parseInt(document.getElementById('testDuration').value);
            
            if (!materialId) {
                showError('Please select a material first.');
                return;
            }
            
            if (!duration || duration < 5 || duration > 120) {
                showError('Please enter a valid duration (5-120 minutes).');
                return;
            }

            showLoading();
            disableControls();
            
            try {
                const token = await getCookie('access_token');
                const response = await fetch('/ai/test/timed', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        material_id: parseInt(materialId),
                        duration: duration
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to generate timed test');
                }

                const testData = await response.json();
                displayTest(testData, true);
                
            } catch (error) {
                console.error('Error generating timed test:', error);
                if (error.message.includes('AI service unavailable')) {
                    showError('AI service is currently unavailable. Please check OpenAI API configuration.');
                } else {
                    showError('Failed to generate timed test: ' + error.message);
                }
                enableControls();
            }
        }

        async function generatePracticeTest() {
            const materialId = document.getElementById('materialSelect').value;
            
            if (!materialId) {
                showError('Please select a material first.');
                return;
            }

            showLoading();
            disableControls();
            
            try {
                const token = await getCookie('access_token');
                const response = await fetch(`/ai/test/practice?material_id=${materialId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to generate practice test');
                }

                const questions = await response.json();
                const testData = {
                    questions: questions,
                    time_limit: 0, // No time limit for practice test
                    instructions: `Complete the ${questions.length} practice questions at your own pace.`
                };
                
                displayTest(testData, false);
                
            } catch (error) {
                console.error('Error generating practice test:', error);
                if (error.message.includes('AI service unavailable')) {
                    showError('AI service is currently unavailable. Please check OpenAI API configuration.');
                } else {
                    showError('Failed to generate practice test: ' + error.message);
                }
                enableControls();
            }
        }

        function displayTest(testData, isTimed) {
            currentTest = testData;
            startTime = Date.now();
            
            hideLoading();
            hideError();
            
            // Show test info
            const testInfo = document.getElementById('testInfo');
            const testTitle = document.getElementById('testTitle');
            const testInstructions = document.getElementById('testInstructions');
            const questionCount = document.getElementById('questionCount');
            
            testTitle.textContent = isTimed ? 'Timed Test' : 'Practice Test';
            testInstructions.textContent = testData.instructions || 'Answer all questions to the best of your ability.';
            questionCount.textContent = `Questions: ${testData.questions.length}`;
            
            testInfo.classList.remove('hidden');
            
            // Hide controls and show test area
            document.querySelector('.test-controls').classList.add('hidden');
            document.getElementById('testArea').classList.remove('hidden');
            
            // Generate questions
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            testData.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <h4>Question ${index + 1}</h4>
                    <p>${question.question}</p>
                    <div class="options">
                        ${question.options.map((option, optionIndex) => `
                            <label>
                                <input type="radio" name="q${index}" value="${optionIndex}">
                                <span>${String.fromCharCode(65 + optionIndex)}. ${option}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            // Start timer if timed test
            if (isTimed && testData.time_limit > 0) {
                startTimer(testData.time_limit);
            }
        }

        function startTimer(minutes) {
            let timeLeft = minutes * 60;
            const timerDisplay = document.getElementById('timerDisplay');
            const timerSpan = document.getElementById('testTimer');
            
            timerDisplay.classList.remove('hidden');
            
            timerInterval = setInterval(() => {
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerSpan.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                // Change color when time is running low
                if (timeLeft <= 300) { // 5 minutes
                    timerDisplay.style.background = 'rgba(239, 68, 68, 0.8)';
                    timerDisplay.style.borderColor = '#ef4444';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest(true); // Auto-submit when time runs out
                    return;
                }
                timeLeft--;
            }, 1000);
        }

        function submitTest(autoSubmit = false) {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            const answers = [];
            const questions = currentTest.questions;
            
            // Collect answers
            questions.forEach((_, index) => {
                const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                answers.push(selectedOption ? parseInt(selectedOption.value) : null);
            });
            
            // Calculate score
            let score = 0;
            const results = [];
            
            questions.forEach((question, index) => {
                const userAnswer = answers[index];
                const correctAnswerText = question.correct_option;
                const correctAnswerIndex = question.options.findIndex(opt => opt === correctAnswerText);
                const isCorrect = userAnswer === correctAnswerIndex;
                
                if (isCorrect) score++;
                
                results.push({
                    question: question.question,
                    userAnswer: userAnswer !== null ? question.options[userAnswer] : 'Not answered',
                    correctAnswer: correctAnswerText,
                    isCorrect: isCorrect
                });
            });
            
            // Calculate completion time
            const completionTime = Math.floor((Date.now() - startTime) / 1000);
            
            // Display results
            displayResults(score, questions.length, results, completionTime, autoSubmit);
        }

        function displayResults(score, total, results, completionTime, autoSubmit) {
            document.getElementById('testArea').classList.add('hidden');
            document.getElementById('timerDisplay').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');
            
            const scoreDisplay = document.getElementById('scoreDisplay');
            const percentage = Math.round((score / total) * 100);
            
            scoreDisplay.textContent = `${score}/${total} (${percentage}%)`;
            scoreDisplay.className = `score-display ${percentage >= 70 ? 'passing' : 'failing'}`;
            
            // Show completion message
            if (autoSubmit) {
                const autoSubmitMsg = document.createElement('div');
                autoSubmitMsg.className = 'error';
                autoSubmitMsg.textContent = '‚è∞ Time expired! Test was automatically submitted.';
                document.getElementById('resultsArea').insertBefore(autoSubmitMsg, scoreDisplay);
            }
            
            // Show completion time
            const timeDisplay = document.createElement('div');
            timeDisplay.style.textAlign = 'center';
            timeDisplay.style.marginBottom = '20px';
            timeDisplay.style.color = 'rgba(255, 255, 255, 0.8)';
            timeDisplay.textContent = `Completed in ${Math.floor(completionTime / 60)}:${(completionTime % 60).toString().padStart(2, '0')}`;
            scoreDisplay.after(timeDisplay);
            
            // Show answer review
            const reviewDiv = document.getElementById('answerReview');
            reviewDiv.innerHTML = '<h3>üìã Answer Review:</h3>';
            
            results.forEach((result, index) => {
                const answerDiv = document.createElement('div');
                answerDiv.className = `answer-item ${result.isCorrect ? 'correct' : 'incorrect'}`;
                answerDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>Q${index + 1}:</strong> ${result.question}
                    </div>
                    <div style="margin-bottom: 5px;">
                        <strong>Your answer:</strong> ${result.userAnswer}
                    </div>
                    <div style="margin-bottom: 5px;">
                        <strong>Correct answer:</strong> ${result.correctAnswer}
                    </div>
                    <div style="font-weight: bold; color: ${result.isCorrect ? '#10b981' : '#ef4444'};">
                        ${result.isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}
                    </div>
                `;
                reviewDiv.appendChild(answerDiv);
            });
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showError(message) {
            const errorEl = document.getElementById('errorState');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorState').classList.add('hidden');
        }

        function disableControls() {
            document.getElementById('generateTimedTest').disabled = true;
            document.getElementById('generatePracticeTest').disabled = true;
            document.getElementById('materialSelect').disabled = true;
            document.getElementById('testDuration').disabled = true;
        }

        function enableControls() {
            document.getElementById('generateTimedTest').disabled = false;
            document.getElementById('generatePracticeTest').disabled = false;
            document.getElementById('materialSelect').disabled = false;
            document.getElementById('testDuration').disabled = false;
        }

        // Event listeners
        document.getElementById('generateTimedTest').addEventListener('click', generateTimedTest);
        document.getElementById('generatePracticeTest').addEventListener('click', generatePracticeTest);
        document.getElementById('submitTest').addEventListener('click', () => submitTest(false));

        // Check for stored test data from AI tools page
        window.addEventListener('DOMContentLoaded', () => {
            loadMaterials();
            
            const storedTest = sessionStorage.getItem('currentTest');
            if (storedTest) {
                try {
                    const testData = JSON.parse(storedTest);
                    sessionStorage.removeItem('currentTest');
                    displayTest(testData, testData.time_limit > 0);
                } catch (error) {
                    console.error('Error loading stored test:', error);
                }
            }
        });

    </script>
</body>
</html>